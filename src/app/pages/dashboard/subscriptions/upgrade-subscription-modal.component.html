<div class="modal-backdrop" *ngIf="isOpen" (click)="close()"></div>
<div class="modal-container" *ngIf="isOpen">
  <div class="modal" role="dialog" aria-modal="true">
    <!-- Header -->
    <div class="modal-header">
      <div>
        <h3>ðŸš€ Upgrade Subscription</h3>
        <p class="subtitle" *ngIf="(resolvedCompanyName() || storeName)">Unlock more features for {{ resolvedCompanyName() || storeName }}</p>
      </div>
      <button class="close-btn" (click)="close()">âœ–</button>
    </div>

    <!-- Content -->
    <div class="modal-content">
      <div class="section">
        <label>Store</label>
        <div class="readonly-box">{{ storeName }}{{ storeCode ? ' (' + storeCode + ')' : '' }}</div>
      </div>

      <div class="grid-2">
        <div class="section">
          <label>Plan</label>
          <select [(ngModel)]="selectedTier">
            <option value="standard">Standard (â‚±{{ planPrice() || 0 }}/mo)</option>
            <option value="premium">Premium (â‚±{{ planPrice() || 0 }}/mo)</option>
          </select>
        </div>
        <div class="section">
          <label>Duration (months)</label>
          <input type="number" min="1" [(ngModel)]="durationMonths" />
        </div>
      </div>

      <div class="grid-2">
        <div class="section">
          <label>Promo Code (optional)</label>
          <input type="text" [(ngModel)]="promoCode" placeholder="Enter code" />
        </div>
        <div class="section">
          <label>Referral Code (optional)</label>
          <input type="text" [(ngModel)]="referralCode" placeholder="Enter referral" />
        </div>
      </div>

      <div class="summary-box">
        <div>Plan Price: <strong>â‚±{{ planPrice() || 0 }}</strong> / mo</div>
        <div>Duration: <strong>{{ durationMonths }} month(s)</strong></div>
        <div>Total Due: <strong>â‚±{{ finalAmount() }}</strong></div>
      </div>

      <h4 class="section-heading">Payment Details</h4>
      <div class="tabs">
        <button [class.active]="activeTab === 'gcash'" (click)="onTabChange('gcash')">GCash</button>
        <button [class.active]="activeTab === 'paymaya'" (click)="onTabChange('paymaya')">PayMaya</button>
  <button [class.active]="activeTab === 'paypal'" (click)="onTabChange('paypal')">Card (PayPal)</button>
      </div>

      <div class="tab-content">
        <p class="help" *ngIf="activeTab === 'gcash'">Scan the GCash QR or send to the official account, then upload your payment screenshot.</p>
        <p class="help" *ngIf="activeTab === 'paymaya'">Pay via PayMaya and upload your payment confirmation screenshot.</p>
  <p class="help" *ngIf="activeTab === 'paypal'">Pay securely by credit or debit card through PayPal.</p>
        

        <!-- QR image / placeholder -->
  <div class="qr-wrapper" *ngIf="activeTab !== 'paypal'">
          <button *ngIf="accountInfo[activeTab].qrUrl" type="button" class="qr-clickable" (click)="openQrPreview()" title="Click to enlarge">
            <img [src]="accountInfo[activeTab].qrUrl" alt="{{ activeTab | titlecase }} QR" class="qr-image"/>
          </button>
          <div *ngIf="!accountInfo[activeTab].qrUrl" class="qr-placeholder">QR not set for {{ activeTab | titlecase }}</div>
        </div>
  <p class="hint" *ngIf="accountInfo[activeTab].qrUrl && activeTab !== 'paypal'">Tip: Click the QR to view a larger version</p>

        <!-- PayPal Card Details (UI only; will be wired with Hosted Fields using your config) -->
  <div class="section" *ngIf="activeTab === 'paypal'">
          <div class="grid-2">
            <div class="section">
              <label>Cardholder Name</label>
              <input type="text" [(ngModel)]="cardName" placeholder="Name on card" autocomplete="cc-name" />
            </div>
            <div class="section">
              <label>Card Number</label>
              <input type="text" [(ngModel)]="cardNumber" placeholder="â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢" autocomplete="cc-number" inputmode="numeric" />
            </div>
          </div>
          <div class="grid-2">
            <div class="section">
              <label>Expiry (MMYY)</label>
              <input type="text" [(ngModel)]="cardExpiry" placeholder="MMYY" maxlength="4" inputmode="numeric" autocomplete="cc-exp" (input)="onCardExpiryInput($event)" />
            </div>
            <div class="section">
              <label>CVV</label>
              <input type="password" [(ngModel)]="cardCvv" placeholder="CVV" maxlength="4" inputmode="numeric" autocomplete="cc-csc" />
            </div>
          </div>
          <!-- Pay action will be enabled once Hosted Fields is wired -->
        </div>

        <div class="payment-details" *ngIf="activeTab !== 'paypal'">
          <div class="detail">
            <div class="label">{{ accountInfo[activeTab].numberLabel || 'Account Number / Mobile Number' }}</div>
            <div class="value">{{ accountInfo[activeTab].numberValue || '09XX XXX XXXX' }}</div>
          </div>
          <div class="detail">
            <div class="label">{{ accountInfo[activeTab].nameLabel || 'Account Name' }}</div>
            <div class="value">{{ accountInfo[activeTab].nameValue || 'Juan Dela Cruz' }}</div>
          </div>
        </div>

        <!-- Payer-provided details -->
        <div class="grid-2 mt-2">
          <div class="section" *ngIf="activeTab !== 'paypal'">
            <label>Reference ID</label>
            <input type="text" [(ngModel)]="paymentReference" placeholder="e.g., GCash Ref / Maya Txn" required />
            <div class="error" *ngIf="showErrors && (!paymentReference || !paymentReference.trim())">Reference ID is required.</div>
          </div>
          <div class="section" *ngIf="activeTab !== 'paypal'">
            <label>{{ activeTab === 'gcash' ? 'GCash Number' : 'PayMaya Number' }}</label>
            <input type="text" [(ngModel)]="payerMobile" placeholder="09XX XXX XXXX or account no." required />
            <div class="error" *ngIf="showErrors && (!payerMobile || !payerMobile.trim())">{{ activeTab === 'gcash' ? 'GCash Number' : 'PayMaya Number' }} is required.</div>
          </div>
        </div>

        <div class="grid-2" *ngIf="activeTab !== 'paypal'">
          <div class="section">
            <label>Payer Name</label>
            <input type="text" [(ngModel)]="payerName" placeholder="Full name" required />
            <div class="error" *ngIf="showErrors && (!payerName || !payerName.trim())">Payer Name is required.</div>
          </div>
          <div class="section">
            <label>Amount</label>
            <input type="number" min="0.01" step="0.01" [(ngModel)]="amountPaid" placeholder="Defaults to total" required />
            <div class="error" *ngIf="showErrors && !isAmountValid()">Enter a valid amount greater than 0.</div>
          </div>
        </div>

        <div class="section" *ngIf="activeTab !== 'paypal'">
          <label>Description</label>
          <textarea rows="2" [(ngModel)]="paymentDescription" placeholder="Optional note about this payment"></textarea>
        </div>
      </div>

      <!-- Amount to pay summary -->
      <div class="pay-summary" *ngIf="activeTab !== 'paypal'">
        <div class="title">Amount to Pay</div>
        <div class="value">â‚±{{ finalAmount() }}</div>
        <div class="note">You will be charged â‚±{{ finalAmount() }} for {{ durationMonths }} month(s) of {{ selectedTier | titlecase }} plan.</div>
      </div>

      <div class="section" *ngIf="activeTab !== 'paypal'">
        <label>Payment Receipt Screenshot</label>
        <input type="file" accept="image/*" (change)="onFileSelected($event)" />
        <p class="hint">.jpg or .png up to ~5MB</p>
        <div class="error" *ngIf="showErrors && !receiptFile">Receipt screenshot is required.</div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn-cancel" (click)="close()">Cancel</button>
      <button class="btn-primary" [disabled]="submitting() || !canSubmit()" (click)="submit()">
        {{ submitting() ? 'Submittingâ€¦' : 'Submit Proof & Upgrade' }}
      </button>
    </div>
  </div>
  
</div>

<!-- QR Preview Overlay -->
<div class="qr-preview-backdrop" *ngIf="qrPreviewOpen()" (click)="closeQrPreview()"></div>
<div class="qr-preview-container" *ngIf="qrPreviewOpen()" role="dialog" aria-modal="true">
  <div class="qr-preview-modal" (click)="$event.stopPropagation()">
    <div class="qr-preview-header">
      <div class="qr-preview-title">{{ activeTab | titlecase }} QR</div>
      <button class="close-btn" (click)="closeQrPreview()">âœ–</button>
    </div>
    <div class="qr-preview-body">
      <img [src]="qrPreviewUrl()" alt="{{ activeTab | titlecase }} QR Large" class="qr-preview-image"/>
      <p class="qr-preview-note">Scan this code with your {{ activeTab | titlecase }} app</p>
    </div>
  </div>
</div>
