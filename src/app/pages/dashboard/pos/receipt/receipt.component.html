<!-- Receipt Modal -->
<div 
  *ngIf="isVisible" 
  class="receipt-modal-overlay"
  (keydown.enter)="onPrintReceipt()">
  
  <div 
    class="receipt-modal-content"
    (click)="onModalContentClick($event)">
    
    <!-- Modal Header with Close Button -->
    <div class="modal-header">
      <h2>{{ receiptData?.storeInfo?.invoiceType || 'Sales Invoice' }} Preview</h2>
      <button 
        class="close-btn"
        (click)="onCloseModal()"
        type="button">
        ×
      </button>
    </div>

    <!-- Receipt Content -->
    <div class="receipt-container">
      
      <!-- Store Information Header -->
      <div class="store-header">
        <div class="company-info">
          <h1 class="company-name">{{ receiptData?.storeInfo?.storeName || 'Store Name' }}</h1>
          <p *ngIf="receiptData?.storeInfo?.address && receiptData?.storeInfo?.address !== 'N/A'" class="company-address">{{ receiptData.storeInfo.address }}</p>
          
          <!-- Contact Information - Only show if values exist -->
          <p *ngIf="receiptData?.storeInfo?.phone || receiptData?.storeInfo?.email" class="company-contact">
            <span *ngIf="receiptData?.storeInfo?.phone && receiptData?.storeInfo?.phone !== 'N/A'">Tel: {{ receiptData.storeInfo.phone }}</span>
            <span *ngIf="receiptData?.storeInfo?.phone && receiptData?.storeInfo?.phone !== 'N/A' && receiptData?.storeInfo?.email && receiptData?.storeInfo?.email !== 'N/A'"> | </span>
            <span *ngIf="receiptData?.storeInfo?.email && receiptData?.storeInfo?.email !== 'N/A'">Email: {{ receiptData.storeInfo.email }}</span>
          </p>
          
          <p *ngIf="receiptData?.storeInfo?.tin && receiptData?.storeInfo?.tin !== 'N/A'" class="tin-number">TIN: {{ receiptData.storeInfo.tin }}</p>
          
          <!-- BIR Information -->
          <div class="bir-info">
            <p *ngIf="receiptData?.storeInfo?.birPermitNo" class="bir-permit">
              <strong>BIR Permit No:</strong> {{ receiptData.storeInfo.birPermitNo }}
            </p>
            <p *ngIf="receiptData?.storeInfo?.inclusiveSerialNumber" class="inclusive-serial">
              <strong>Serial Number:</strong> {{ receiptData.storeInfo.inclusiveSerialNumber }}
            </p>
            <p *ngIf="receiptData?.storeInfo?.minNumber" class="min-number">
              <strong>MIN:</strong> {{ receiptData.storeInfo.minNumber }}
            </p>
          </div>
          
          <!-- Invoice Number -->
          <p class="invoice-number"><strong>Invoice #: {{ receiptData?.invoiceNumber || 'Auto-generated' }}</strong></p>
          
          <!-- Dynamic Invoice Type Label -->
          <p class="sales-invoice-label">{{ receiptData?.storeInfo?.invoiceType || 'SALES INVOICE' }}</p>
        </div>
      </div>

      <!-- Payment Method Indicators -->
      <div class="payment-indicators-section">
        <div class="payment-circles">
          <div class="payment-option">
            <span>Cash</span>
            <div class="circle" [class.filled]="receiptData?.isCashSale"></div>
          </div>
          <div class="payment-option">
            <span>Charge</span>
            <div class="circle" [class.filled]="receiptData?.isChargeSale"></div>
          </div>
        </div>
      </div>

      <!-- Sold To Section -->
      <div class="sold-to-section">
        <h3 class="sold-to-header">SOLD TO: 
          <ng-container *ngIf="receiptData?.customerNames && receiptData.customerNames.length > 0; else singleCustomer">
            <span *ngFor="let n of receiptData.customerNames; let i = index">
              {{ n }}<span *ngIf="i < (receiptData.customerNames.length - 1)">, </span>
            </span>
          </ng-container>
          <ng-template #singleCustomer>{{ getCustomerDisplayName() }}</ng-template>
        </h3>

        <!-- Only show address/TIN when there's a single recognized customer (keeps layout predictable) -->
        <div class="customer-info" *ngIf="hasCustomerDetails() && (!receiptData?.customerNames || receiptData.customerNames.length <= 1)">
          <div *ngIf="receiptData?.customerAddress && receiptData?.customerAddress !== 'N/A'">
            <p><strong>Address:</strong> {{ receiptData.customerAddress }}</p>
          </div>
          <div *ngIf="receiptData?.customerTin && receiptData?.customerTin !== 'N/A'">
            <p><strong>TIN:</strong> {{ receiptData.customerTin }}</p>
          </div>
        </div>
      </div>

      <!-- Cashier and Date Section -->
      <div class="cashier-date-section">
        <div class="cashier-date-layout">
          <p class="cashier-info"><strong>Cashier:</strong> {{ receiptData?.cashier || 'N/A' }}</p>
          <p class="date-info"><strong>Date:</strong> {{ receiptData?.receiptDate | date:'medium' }}</p>
        </div>
      </div>

      <!-- Products Table -->
      <div class="products-section">
        <table class="products-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Amount</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of receiptData?.items || []">
              <td>
                <div class="sku-product-info">
                  <div class="product-name">{{ item.productName }}</div>
                  <div class="sku-value">{{ item.skuId }}</div>
                </div>
              </td>
              <td>{{ formatQuantityWithUnit(item.quantity, item.unitType) }}</td>
              <td>₱{{ item.sellingPrice?.toFixed(2) }}</td>
              <td>₱{{ item.total?.toFixed(2) }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Totals Section -->
      <div class="totals-section">
        <div class="totals-grid">
          <div class="total-line">
            <span>Subtotal:</span>
            <span>₱{{ receiptData?.subtotal?.toFixed(2) || '0.00' }}</span>
          </div>
          <div class="total-line">
            <span>VAT ({{ receiptData?.vatRate || 12 }}%):</span>
            <span>₱{{ receiptData?.vatAmount?.toFixed(2) || '0.00' }}</span>
          </div>
          <div class="total-line">
            <span>VAT Exempt:</span>
            <span>₱{{ receiptData?.vatExempt?.toFixed(2) || '0.00' }}</span>
          </div>
          <div class="total-line">
            <span>Discount:</span>
            <span>₱{{ receiptData?.discount?.toFixed(2) || '0.00' }}</span>
          </div>
          <div class="total-line grand-total">
            <span><strong>Total Amount:</strong></span>
            <span><strong>₱{{ receiptData?.totalAmount?.toFixed(2) || '0.00' }}</strong></span>
          </div>
        </div>
      </div>

      <!-- Discount Information Section (supports multiple per-customer discounts) -->
      <div class="discount-info-section" *ngIf="(receiptData?.customerDiscounts && receiptData.customerDiscounts.length > 0); else legacyDiscount">
        <div class="discount-details">
          <h4>Discount Information</h4>
          <div class="discount-grid">
            <ng-container *ngFor="let cd of receiptData.customerDiscounts">
              <div class="discount-block">
                <div class="discount-line">
                  {{ cd.type || 'CUSTOM' }} Discount
                </div>
                <div class="discount-line" *ngIf="cd.exemptionId">
                  ID: {{ cd.exemptionId }}
                </div>
                <div class="discount-line" *ngIf="cd.customerName">
                  {{ cd.customerName }}
                </div>
                <div class="discount-line">
                  Discount Amount: ₱{{ (cd.discountAmount || 0).toFixed(2) }}
                </div>
                <div class="signature-section" *ngIf="cd.type === 'PWD' || cd.type === 'SENIOR'">
                  <div class="signature-box">
                    <p class="signature-label">Customer Signature:</p>
                    <div class="signature-line">_________________________</div>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
      <ng-template #legacyDiscount>
        <!-- Fallback single orderDiscount block for older receipts -->
        <div class="discount-info-section" *ngIf="receiptData?.orderDiscount">
          <div class="discount-details">
            <h4>Discount Information</h4>
            <div class="discount-grid">
              <div class="discount-line">
                {{ receiptData.orderDiscount.type }} 
                <ng-container *ngIf="receiptData.orderDiscount.customType">
                  ({{ receiptData.orderDiscount.customType }})
                </ng-container>
                Discount
              </div>
              <div class="discount-line" *ngIf="receiptData.orderDiscount.exemptionId">
                ID: {{ receiptData.orderDiscount.exemptionId }}
              </div>
              <div class="discount-line" *ngIf="receiptData.orderDiscount.customerName">
                {{ receiptData.orderDiscount.customerName }}
              </div>
              <div class="discount-line">
                Discount Amount: ₱{{ receiptData?.discount?.toFixed(2) || '0.00' }}
              </div>
            </div>
            
            <!-- Signature Section -->
            <div class="signature-section" *ngIf="receiptData.orderDiscount.type === 'PWD' || receiptData.orderDiscount.type === 'SENIOR'">
              <div class="signature-box">
                <p class="signature-label">Customer Signature:</p>
                <div class="signature-line">
                  <span *ngIf="receiptData.orderDiscount.signature">{{ receiptData.orderDiscount.signature }}</span>
                  <span *ngIf="!receiptData.orderDiscount.signature">_________________________</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-template>

      <!-- Footer -->
      <div class="receipt-footer">
        <p class="thank-you">Thank you for your business!</p>
        <p class="footer-note">{{ receiptData?.validityNotice || 'This serves as your official receipt.' }}</p>
        <p class="date-printed">Printed on: {{ receiptData?.receiptDate | date:'medium' }}</p>
      </div>

    </div>

    <!-- Print Options -->
  <!-- Print Options Removed for Cleanup -->

    <!-- Modal Actions -->
    <div class="modal-actions">
   
      <button 
        class="btn-secondary"
        (click)="onCloseModal()">
        Close
      </button>
      <button 
        class="btn-primary"
        #printBtn
        autofocus
        (click)="onPrintReceipt()"
        [disabled]="isPrinting">
        <span *ngIf="!isPrinting">Print Receipt</span>
        <span *ngIf="isPrinting">Saving & Printing...</span>
      </button>
    </div>

  </div>
</div>
