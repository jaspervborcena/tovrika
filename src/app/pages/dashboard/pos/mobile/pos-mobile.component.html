<!-- MOBILE POS - BUILT FROM SCRATCH WITH ROW LAYOUT -->
<app-header></app-header>

<div class="mobile-pos-wrapper">
  
  <!-- NAVIGATION TOGGLE BUTTON -->
  <div class="navigation-toggle-row">
    <button class="navigation-toggle-btn" (click)="toggleNavigationPanel()">
      <span class="toggle-icon" [class.expanded]="!isNavigationCollapsed()">‚ñº</span>
      <span class="toggle-text">{{ isNavigationCollapsed() ? 'Show Controls' : 'Hide Controls' }}</span>
      <span class="controls-hint">Store ‚Ä¢ Invoice ‚Ä¢ Categories ‚Ä¢ Customer ‚Ä¢ Access</span>
    </button>
  </div>

  <!-- COLLAPSIBLE NAVIGATION SECTION -->
  <div class="navigation-section" [class.collapsed]="isNavigationCollapsed()">
    
    <!-- ROW 1: STORES SELECTION -->
    <div class="pos-row stores-row">
      <div class="row-header">üè™ {{ 'pos.store' | translate }}</div>
      <div class="stores-tabs-container">
        <button 
          *ngFor="let store of availableStores()" 
          class="mobile-tab"
          [class.active]="selectedStoreId() === store.id"
          (click)="selectStore(store.id!)">
          {{ store.storeName }}
        </button>
      </div>
    </div>

    <!-- ROW 2: INVOICE SETTINGS -->
    <div class="pos-row invoice-row">
      <div class="row-header">üìÑ {{ 'pos.receipt' | translate }}</div>
      <div class="invoice-table-container">
        <table class="invoice-table">
          <tr>
            <td class="invoice-label">Date & Time:</td>
            <td class="invoice-input">
              <input type="datetime-local" [(ngModel)]="datetime" class="invoice-datetime-input">
            </td>
          </tr>
          <tr>
            <td class="invoice-label">Invoice Number:</td>
            <td class="invoice-input">
              <input type="text" [(ngModel)]="invoiceNumber" placeholder="Auto-generated" readonly class="invoice-number-input">
            </td>
          </tr>
        </table>
      </div>
    </div>

    <!-- ROW 3: CATEGORIES TABS -->
    <div class="pos-row categories-row">
      <div class="row-header">üìÇ {{ 'pos.categories' | translate }}</div>
      <div class="categories-tabs-container">
        <button 
          class="mobile-tab"
          [class.active]="selectedCategory() === 'all'"
          (click)="setSelectedCategory('all')">
          All Products
        </button>
        <button 
          *ngFor="let category of categories()"
          class="mobile-tab"
          [class.active]="selectedCategory() === category"
          (click)="setSelectedCategory(category)">
          {{ category }}
        </button>
      </div>
    </div>

    <!-- ROW 4: CUSTOMER INFORMATION -->
    <div class="pos-row customer-row">
      <div class="row-header" (click)="toggleSoldToPanel()">
        üë§ Customer
        <span class="expand-arrow" [class.expanded]="!isSoldToCollapsed()">‚ñº</span>
      </div>
      
      <!-- Always visible customer name -->
      <div class="mobile-field-group">
        <input 
          type="text" 
          [(ngModel)]="customerInfo.soldTo"
          placeholder="Customer Name (Optional)"
          class="customer-name-field">
      </div>
      
      <!-- Expandable customer details -->
      <div class="customer-details" [class.hidden]="isSoldToCollapsed()">
        <div class="mobile-field-group">
          <label>TIN:</label>
          <input type="text" [(ngModel)]="customerInfo.tin" placeholder="123-456-789-000">
        </div>
        <div class="mobile-field-group">
          <label>Business Address:</label>
          <input type="text" [(ngModel)]="customerInfo.businessAddress" placeholder="Full Address">
        </div>
      </div>
    </div>

    <!-- ROW 5: ACCESS TABS -->
    <div class="pos-row access-row">
      <div class="row-header">‚ö° Access</div>
      <div class="access-tabs-container">
        <button 
          *ngFor="let tab of accessTabs" 
          class="mobile-tab"
          [class.active]="accessTab() === tab"
          (click)="setAccessTab(tab)">
          {{ tab }}
        </button>
      </div>
    </div>

  </div>

  <!-- ROW 6: SEARCH & VIEW OPTIONS -->
  <div class="pos-row search-row">
    <div class="row-header">üîç {{ 'pos.search' | translate }}</div>
    <div class="search-container">
      <div class="search-input-container">
        <input 
          type="text"
          [ngModel]="searchQuery()"
          (ngModelChange)="setSearchQuery($event)"
          (input)="onSearch()"
          [placeholder]="accessTab() === 'Orders' ? 'Search Orders...' : 'Search Products...'"
          class="mobile-search">
        <button *ngIf="searchQuery()" (click)="clearSearch()" class="clear-btn">√ó</button>
      </div>
      
      <!-- View Options for Products -->
      <div class="view-options" *ngIf="accessTab() === 'New'">
        <button 
          [class.active]="currentView() === 'list'"
          (click)="setCurrentView('list')"
          class="view-btn">List</button>
        <button 
          [class.active]="currentView() === 'grid'"
          (click)="setCurrentView('grid')"
          class="view-btn">Grid</button>
        <button 
          [class.active]="currentView() === 'custom'"
          (click)="setCurrentView('custom')"
          class="view-btn">Promos</button>
        <button 
          [class.active]="currentView() === 'bestsellers'"
          (click)="setCurrentView('bestsellers')"
          class="view-btn">Top</button>
      </div>
    </div>
  </div>

  <!-- ROW 7: MAIN CONTENT (Products or Orders) -->
  <div class="pos-row content-row">
    
    <!-- PRODUCTS SECTION -->
    <div *ngIf="accessTab() === 'New'">
      <div class="row-header">üì¶ Products</div>
      
      <!-- List View Products -->
      <div *ngIf="currentView() === 'list'" class="products-list-mobile">
        <div 
          *ngFor="let product of filteredProducts()"
          (click)="addToCart(product)"
          class="product-row"
          [class.disabled]="isOrderCompleted()"
          [class.out-of-stock]="product.totalStock <= 0">
          <img [src]="product.imageUrl || 'assets/noimage.png'" class="product-thumb" onerror="this.src='assets/noimage.png'">
          <div class="product-details">
            <div class="product-name">{{ product.productName }}</div>
            <div class="product-sku">SKU: {{ product.skuId }}</div>
            <div class="product-stock">{{ 'products.stock' | translate }}: {{ product.totalStock }}</div>
          </div>
          <div class="product-pricing">
            <div class="product-price">‚Ç±{{ (product.sellingPrice || 0).toFixed(2) }}</div>
            <div *ngIf="product.hasDiscount" class="discount-tag">{{ product.discountValue }}% OFF</div>
          </div>
          <div *ngIf="isOrderCompleted()" class="order-completed-overlay">
            <span>Order Completed</span>
          </div>
        </div>
      </div>

      <!-- Grid View Products -->
      <div *ngIf="currentView() === 'grid'" class="products-grid-mobile">
        <div 
          *ngFor="let product of filteredProducts()"
          (click)="addToCart(product)"
          class="product-card"
          [class.disabled]="isOrderCompleted()"
          [class.out-of-stock]="product.totalStock <= 0">
          <img [src]="product.imageUrl || 'assets/noimage.png'" class="product-image" onerror="this.src='assets/noimage.png'">
          <div class="product-card-info">
            <div class="product-name">{{ product.productName }}</div>
            <div class="product-price">‚Ç±{{ (product.sellingPrice || 0).toFixed(2) }}</div>
            <div class="product-stock">Stock: {{ product.totalStock }}</div>
            <div *ngIf="product.hasDiscount" class="promo-badge">PROMO</div>
          </div>
          <div *ngIf="isOrderCompleted()" class="order-completed-overlay">
            <span>Order Completed</span>
          </div>
        </div>
      </div>

      <!-- Promotional Products -->
      <div *ngIf="currentView() === 'custom'" class="promo-products-mobile">
        <div class="sub-header">üè∑Ô∏è Promotional Items</div>
        <div class="products-grid-mobile">
          <div 
            *ngFor="let product of promoProducts()"
            (click)="addToCart(product)"
            class="product-card promo-card"
            [class.disabled]="isOrderCompleted()"
            [class.out-of-stock]="product.totalStock <= 0">
            <div class="promo-flag">PROMO</div>
            <img [src]="product.imageUrl || 'assets/noimage.png'" class="product-image" onerror="this.src='assets/noimage.png'">
            <div class="product-card-info">
              <div class="product-name">{{ product.productName }}</div>
              <div class="product-price">‚Ç±{{ (product.sellingPrice || 0).toFixed(2) }}</div>
              <div class="discount-info">{{ product.discountValue }}% OFF</div>
            </div>
            <div *ngIf="isOrderCompleted()" class="order-completed-overlay">
              <span>Order Completed</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Best Sellers -->
      <div *ngIf="currentView() === 'bestsellers'" class="bestsellers-mobile">
        <div class="sub-header">üèÜ Best Selling Products</div>
        <div class="products-list-mobile">
          <div 
            *ngFor="let product of bestSellerProducts(); let i = index"
            (click)="addToCart(product)"
            class="product-row bestseller-row"
            [class.disabled]="isOrderCompleted()"
            [class.out-of-stock]="product.totalStock <= 0">
            <div class="rank-badge">{{ i + 1 }}</div>
            <img [src]="product.imageUrl || 'assets/noimage.png'" class="product-thumb" onerror="this.src='assets/noimage.png'">
            <div class="product-details">
              <div class="product-name">{{ product.productName }}</div>
              <div class="product-sku">SKU: {{ product.skuId }}</div>
            </div>
            <div class="product-pricing">
              <div class="product-price">‚Ç±{{ (product.sellingPrice || 0).toFixed(2) }}</div>
            </div>
            <div *ngIf="isOrderCompleted()" class="order-completed-overlay">
              <span>Order Completed</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ORDERS SECTION -->
    <div *ngIf="accessTab() === 'Orders'">
      <div class="row-header">üìã Order History</div>
      
      <div *ngIf="isLoadingOrders()" class="loading-state">Loading orders...</div>
      
      <div *ngIf="!isLoadingOrders() && orders().length === 0" class="empty-state">No orders found</div>
      
      <div class="orders-list-mobile">
        <div 
          *ngFor="let order of orders()"
          (dblclick)="openOrder(order)"
          class="order-row">
          <div class="order-info">
            <div class="order-number">{{ order.invoiceNumber || order.orderNumber || order.id }}</div>
            <div class="order-meta">
              {{ order.date?.toDate ? (order.date.toDate() | date:'short') : (order.createdAt?.toDate ? (order.createdAt.toDate() | date:'short') : '') }}
              <br>
              {{ order.soldTo || order.customerName || 'Walk-in Customer' }}
            </div>
          </div>
          <div class="order-summary">
            <div class="order-total">‚Ç±{{ order.totalAmount | number:'1.2-2' }}</div>
            <div class="order-status">{{ order.status }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Floating Action Buttons -->
<div class="floating-actions">
  <button class="fab new-order-fab" (click)="startNewOrderDirect()" title="New Order">
    üÜï
  </button>
  <app-cart-fab (cartOpened)="showCartModal()"></app-cart-fab>
</div>

<!-- Mobile Cart Modal -->
<app-mobile-cart-modal 
  #cartModal
  [isOrderCompleted]="isOrderCompleted()"
  (modalClosed)="hideCartModal()"
  (orderProcessed)="processOrder()">
</app-mobile-cart-modal>

<!-- ORDER DETAIL MODAL -->
<div *ngIf="selectedOrder()" class="modal-overlay" (click)="closeOrder()">
  <div class="order-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Order Details</h3>
      <button (click)="closeOrder()" class="modal-close-btn">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="order-info-section">
        <div class="info-row">
          <strong>Invoice Number:</strong> {{ selectedOrder()?.invoiceNumber || 'N/A' }}
        </div>
        <div class="info-row">
          <strong>Date:</strong> {{ selectedOrder()?.date?.toDate ? (selectedOrder()?.date.toDate() | date:'full') : '' }}
        </div>
        <div class="info-row">
          <strong>Customer:</strong> {{ selectedOrder()?.soldTo || 'Walk-in' }}
        </div>
        <div class="info-row">
          <strong>Status:</strong> {{ selectedOrder()?.status }}
        </div>
        <div class="info-row">
          <strong>{{ 'pos.total' | translate }} {{ 'pos.amount' | translate }}:</strong> ‚Ç±{{ selectedOrder()?.totalAmount | number:'1.2-2' }}
        </div>
      </div>
      
      <!-- BIR Information Section -->
      <div class="bir-section">
        <h4>BIR Information</h4>
        <div class="info-row">
          <strong>ATP/OCN:</strong> {{ selectedOrder()?.atpOrOcn }}
        </div>
        <div class="info-row">
          <strong>BIR Permit:</strong> {{ selectedOrder()?.birPermitNo }}
        </div>
        <div class="info-row">
          <strong>Serial Range:</strong> {{ selectedOrder()?.inclusiveSerialNumber }}
        </div>
      </div>
      
      <div class="modal-actions">
        <button (click)="closeOrder()" class="mobile-btn secondary-btn">Close</button>
        <button (click)="openOrderReceipt(selectedOrder())" class="mobile-btn info-btn">View Receipt</button>
        <button *ngIf="selectedOrder()?.status !== 'Cancelled'" 
                (click)="updateOrderStatus(selectedOrder()?.id, 'Cancelled')" 
                class="mobile-btn warning-btn">Cancel Order</button>
        <button *ngIf="selectedOrder()?.status !== 'Refunded'" 
                (click)="updateOrderStatus(selectedOrder()?.id, 'Refunded')" 
                class="mobile-btn primary-btn">Process Refund</button>
      </div>
    </div>
  </div>
</div>

<!-- Receipt Modal -->
<app-receipt
  [isVisible]="isReceiptModalVisible()"
  [receiptData]="receiptData()"
  (closeModal)="closeReceiptModal()"
  (printReceipt)="printReceipt()">
</app-receipt>



<!-- Confirmation Dialog -->
<div *ngIf="isConfirmationDialogVisible()" class="modal-overlay">
  <div class="confirmation-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ confirmationDialogData()?.title }}</h3>
    </div>
    
    <div class="modal-body">
      <p>{{ confirmationDialogData()?.message }}</p>
    </div>
    
    <div class="modal-footer">
      <button 
        *ngIf="confirmationDialogData()?.cancelText"
        (click)="confirmationDialogData()?.onCancel?.()" 
        class="mobile-btn secondary-btn">
        {{ confirmationDialogData()?.cancelText }}
      </button>
      <button 
        (click)="confirmationDialogData()?.onConfirm?.()" 
        [class]="'mobile-btn ' + (confirmationDialogData()?.type === 'danger' ? 'danger-btn' : confirmationDialogData()?.type === 'warning' ? 'warning-btn' : 'primary-btn')">
        {{ confirmationDialogData()?.confirmText }}
      </button>
    </div>
  </div>
</div>
