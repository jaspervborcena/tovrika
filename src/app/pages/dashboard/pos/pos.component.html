<div class="pos-container">
      <app-header></app-header>
      
      

      <!-- Main POS Layout -->
      <div class="pos-layout">
        <!-- Left Panel: Categories & Products -->
        <div class="left-panel">
          
          <!-- NAVIGATION TOGGLE BUTTON -->
          <div class="navigation-toggle-row">
            <button class="navigation-toggle-btn" (click)="toggleNavigationPanel()">
              <span class="toggle-icon" [class.expanded]="!isNavigationCollapsed()">‚ñº</span>
              <span class="toggle-text">{{ isNavigationCollapsed() ? ('pos.showControls' | translate) : ('pos.hideControls' | translate) }}</span>
              <span class="controls-hint">{{ 'pos.controlsHint' | translate }}</span>
            </button>
          </div>

          <!-- COLLAPSIBLE NAVIGATION SECTION -->
          <div class="navigation-section" [class.collapsed]="isNavigationCollapsed()">
            
            <!-- Store Selection -->
            <div class="store-selection-section">
              <h3>üè™ {{ 'pos.selectStore' | translate }}</h3>
              <div class="store-buttons-inline">
                <button
                  *ngFor="let store of availableStores()"
                  [class.active]="selectedStoreId() === store.id"
                  (click)="selectStore(store.id!)"
                  class="store-btn-inline"
                  title="{{ store.storeName }}">
                  {{ store.storeName }}
                </button>
                <!-- Fallback if no stores -->
                <div *ngIf="availableStores().length === 0" class="no-stores-message">
                  {{ 'messages.noDataFound' | translate }}
                </div>
              </div>
            </div>
            
            <!-- Compact Categories & Customer Panel -->
            <div class="categories-panel compact-layout">
            <!-- Left Column: Categories -->
            <div class="categories-column">
              <h3>üìÇ {{ 'pos.categories' | translate }}</h3>
              
              <!-- Categories -->
              <div class="category-list two-columns">
                <button 
                  [class.active]="selectedCategory() === 'all'"
                  (click)="setSelectedCategory('all')"
                  class="category-btn">
                  {{ 'pos.allProducts' | translate }}
                </button>
                <button 
                  *ngFor="let category of categories()"
                  [class.active]="selectedCategory() === category"
                  (click)="setSelectedCategory(category)"
                  class="category-btn">
                  {{ category }}
                </button>
              </div>
            </div>

            <!-- Right Column: Customer Information -->
            <div class="customer-column">
              <!-- Sales Type Checkboxes -->
              <div class="sales-type-section">
                <div class="sales-type-checkboxes">
                  <label class="sales-type-option">
                    <input 
                      type="checkbox" 
                      [checked]="isCashSale()"
                      (change)="toggleCashSale()"
                      class="sales-type-checkbox">
                    <span class="checkbox-label">üíµ {{ 'pos.cashPayment' | translate }}</span>
                  </label>
                  <label class="sales-type-option">
                    <input 
                      type="checkbox" 
                      [checked]="isChargeSale()"
                      (change)="toggleChargeSale()"
                      class="sales-type-checkbox">
                    <span class="checkbox-label">üí≥ {{ 'pos.cardPayment' | translate }}</span>
                  </label>
                </div>
              </div>
              
              <!-- Customer Header -->
              <div class="customer-header" (click)="toggleSoldToPanel()">
                <h3>üë§ {{ 'pos.customer' | translate }}</h3>
                <span class="expand-arrow" [class.expanded]="!isSoldToCollapsed()">‚ñº</span>
              </div>
              
              <!-- Always visible customer name -->
              <div class="customer-field-group">
                <input 
                  type="text" 
                  [(ngModel)]="customerInfo.soldTo"
                  [placeholder]="'pos.customerNamePlaceholder' | translate"
                  class="customer-name-input">
              </div>
              
              <!-- Expandable customer details -->
              <div class="customer-details" [class.hidden]="isSoldToCollapsed()">
                <div class="customer-field-group">
                  <label>{{ 'pos.tinLabel' | translate }}:</label>
                  <input type="text" [(ngModel)]="customerInfo.tin" [placeholder]="'pos.tinPlaceholder' | translate">
                </div>
                <div class="customer-field-group">
                  <label>{{ 'pos.businessAddressLabel' | translate }}:</label>
                  <input type="text" [(ngModel)]="customerInfo.businessAddress" [placeholder]="'pos.businessAddressPlaceholder' | translate">
                </div>
              </div>
            </div>
          </div>

          <!-- Search Bar -->
          <!-- Access Tabs (New, Orders, Cancelled, Refunds & Returns, Split Payments, Discounts & Promotions) -->
          <div class="access-tabs" style="padding: 0 1rem;">
            <div class="access-tab-list">
              <button *ngFor="let t of accessTabs" 
                      (click)="setAccessTab(t)"
                      [class.active]="accessTab() === t"
                      class="tab-header">
                <div class="tab-content">
                  <span class="tab-label">{{ getAccessTabTranslation(t) }}</span>
                </div>
              </button>
            </div>
          </div>

          </div> <!-- End of COLLAPSIBLE NAVIGATION SECTION -->

          <div class="search-section">
            <div class="search-sort-row">
              <!-- Search Area -->
              <div class="search-area">
                <div class="search-input-wrap">
                  <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                  <input 
                    type="text"
                    [ngModel]="searchQuery()"
                    (ngModelChange)="setSearchQuery($event)"
                    (input)="onSearch()"
                    [placeholder]="accessTab() === 'Orders' ? 'Search Orders (Invoice #, Customer Name, Address, Date YYYYMMDD)' : 'Search by barcode, SKU, or name...'"
                    class="search-input">
                  <button *ngIf="searchQuery()" (click)="clearSearch()" class="clear-btn" title="Clear">√ó</button>
                </div>
                <!-- Filter button toggles the left controls for quick access -->
                <button class="filter-btn" (click)="toggleNavigationPanel()" title="Filter / Show Controls">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <polygon points="22 3 2 3 10 12 10 19 14 21 14 12 22 3"></polygon>
                  </svg>
                </button>
              </div>

              <!-- Sort Area -->
              <div class="sort-area" (click)="$event.stopPropagation()">
                <button class="sort-menu-btn" 
                        (click)="toggleSortMenu($event)" 
                        [class.active]="sortMenuOpen()"
                        [title]="sortMode() === 'asc' ? 'Alphabetical ascending' : (sortMode() === 'desc' ? 'Alphabetical descending' : 'Starts from middle letter (M) and fans outward')">
                  <span class="sort-emoji" aria-hidden="true">{{ sortMode() === 'asc' ? 'üî§' : (sortMode() === 'desc' ? 'üî°' : 'üîÅ') }}</span>
                  <span class="sort-label">{{ sortMode() === 'asc' ? 'A‚ÄìZ Sort' : (sortMode() === 'desc' ? 'Z‚ÄìA Sort' : 'Midpoint Sort') }}</span>
                </button>
                <div class="sort-dropdown" *ngIf="sortMenuOpen()">
                  <button class="sort-option" [class.active]="sortMode() === 'asc'" (click)="setSortMode('asc'); closeSortMenu()">
                    <span class="label">üî§ A‚ÄìZ Sort</span>
                    <span class="desc">Alphabetical ascending</span>
                  </button>
                  <button class="sort-option" [class.active]="sortMode() === 'desc'" (click)="setSortMode('desc'); closeSortMenu()">
                    <span class="label">üî° Z‚ÄìA Sort</span>
                    <span class="desc">Alphabetical descending</span>
                  </button>
                  <button class="sort-option" [class.active]="sortMode() === 'mid'" (click)="setSortMode('mid'); closeSortMenu()">
                    <span class="label">üîÅ Midpoint Sort</span>
                    <span class="desc">Starts from middle letter (M) and fans outward</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Product View Tabs -->
          <div class="product-tabs" *ngIf="accessTab() === 'New'">
            <button 
              [class.active]="currentView() === 'list'"
              (click)="setCurrentView('list')"
              class="tab-btn">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
              </svg>
              {{ 'pos.listView' | translate }}
            </button>
            <button 
              [class.active]="currentView() === 'grid'"
              (click)="setCurrentView('grid')"
              class="tab-btn">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
              </svg>
              {{ 'pos.gridView' | translate }}
            </button>
            <button 
              [class.active]="currentView() === 'custom'"
              (click)="setCurrentView('custom')"
              class="tab-btn">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
              </svg>
              {{ 'pos.promosView' | translate }}
            </button>
            <button 
              [class.active]="currentView() === 'bestsellers'"
              (click)="setCurrentView('bestsellers')"
              class="tab-btn">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              {{ 'pos.bestSellersView' | translate }}
            </button>
            <button 
              [class.active]="currentView() === 'favorites'"
              (click)="setCurrentView('favorites')"
              class="tab-btn">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.97a1 1 0 00.95.69h4.178c.969 0 1.371 1.24.588 1.81l-3.383 2.46a1 1 0 00-.364 1.118l1.287 3.97c.3.922-.755 1.688-1.54 1.118l-3.383-2.46a1 1 0 00-1.175 0l-3.383 2.46c-.784.57-1.838-.196-1.539-1.118l1.287-3.97a1 1 0 00-.364-1.118L2.997 9.397c-.783-.57-.38-1.81.588-1.81h4.178a1 1 0 00.95-.69l1.286-3.97z"/>
              </svg>
              Favorites
            </button>
          </div>

            <!-- Products Display (shown only for New access tab). Orders will use the same area for results -->
            <div class="products-display" *ngIf="accessTab() === 'New'">
            <!-- List View -->
            <div *ngIf="currentView() === 'list'" class="products-list">
              <div 
                *ngFor="let product of filteredProducts()"
                (click)="addToCart(product)"
                class="product-list-item"
                [class.disabled]="!canInteractWithProducts()">
                <img 
                  [src]="product.imageUrl || 'assets/noimage.png'"
                  [alt]="product.productName"
                  class="product-image-small"
                  onerror="this.src='assets/noimage.png'">
                <div class="product-info">
                  <h4>{{ product.productName }}</h4>
                  <p class="product-sku">{{ product.skuId }}</p>
                  <p class="product-stock">Stock: {{ product.totalStock }}</p>
                </div>
                <div class="product-price">
                  ‚Ç±{{ (product.sellingPrice || 0).toFixed(2) }}
                  <span *ngIf="product.hasDiscount" class="discount-badge">
                    {{ product.discountType === 'percentage' ? product.discountValue + '%' : '$' + product.discountValue }} OFF
                  </span>
                </div>
              </div>
            </div>

            <!-- Grid View -->
            <div *ngIf="currentView() === 'grid'" class="products-grid">
              <div 
                *ngFor="let product of displayGridProducts()"
                (click)="addToCart(product)"
                class="product-grid-item"
                [class.disabled]="!canInteractWithProducts()">
                <img 
                  [src]="product.imageUrl || 'assets/noimage.png'"
                  [alt]="product.productName"
                  class="product-image"
                  onerror="this.src='assets/noimage.png'">
                <div class="product-details">
                  <div class="product-name-price">
                    <h4>{{ product.productName }}</h4>
                    <span class="price">‚Ç±{{ (product.sellingPrice || 0).toFixed(2) }}</span>
                  </div>
                  <div class="product-category-stock">
                    <p class="product-description">{{ product.category }}</p>
                    <span class="product-stock">Stock: {{ product.totalStock }}</span>
                  </div>
                  <div *ngIf="product.hasDiscount" class="discount">
                    {{ product.discountType === 'percentage' ? product.discountValue + '% OFF' : '$' + product.discountValue + ' OFF' }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Favorites View (same as Grid but filtered by isFavorite) -->
            <div *ngIf="currentView() === 'favorites'" class="products-grid">
              <div 
                *ngFor="let product of displayFavoriteGridProducts()"
                (click)="addToCart(product)"
                class="product-grid-item"
                [class.disabled]="!canInteractWithProducts()">
                <img 
                  [src]="product.imageUrl || 'assets/noimage.png'"
                  [alt]="product.productName"
                  class="product-image"
                  onerror="this.src='assets/noimage.png'">
                <div class="product-details">
                  <div class="product-name-price">
                    <h4>{{ product.productName }}</h4>
                    <span class="price">‚Ç±{{ (product.sellingPrice || 0).toFixed(2) }}</span>
                  </div>
                  <div class="product-category-stock">
                    <p class="product-description">{{ product.category }}</p>
                    <span class="product-stock">Stock: {{ product.totalStock }}</span>
                  </div>
                  <div *ngIf="product.hasDiscount" class="discount">
                    {{ product.discountType === 'percentage' ? product.discountValue + '% OFF' : '$' + product.discountValue + ' OFF' }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Show More button for grid view -->
            <div *ngIf="(currentView() === 'grid' || currentView() === 'favorites') && hasMoreGridProducts()" class="show-more-row">
              <button class="btn btn-secondary show-more-btn" (click)="showMoreGridProducts()">Show more</button>
            </div>

            <!-- Custom/Promos View -->
            <div *ngIf="currentView() === 'custom'" class="custom-products">
              <div class="custom-section">
                <h4>Promotional Items</h4>
                <div class="products-grid">
                  <div 
                    *ngFor="let product of promoProducts()"
                    (click)="addToCart(product)"
                    class="product-grid-item promo"
                    [class.disabled]="!canInteractWithProducts()">
                    <div class="promo-badge">PROMO</div>
                    <img 
                      [src]="product.imageUrl || 'assets/noimage.png'"
                      [alt]="product.productName"
                      class="product-image"
                      onerror="this.src='assets/noimage.png'">
                    <div class="product-details">
                      <h4>{{ product.productName }}</h4>
                      <div class="product-pricing">
                        <span class="price">‚Ç±{{ product.sellingPrice.toFixed(2) }}</span>
                        <span class="discount">{{ product.discountValue }}% OFF</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Best Sellers View -->
            <div *ngIf="currentView() === 'bestsellers'" class="bestsellers-products">
              <div class="bestsellers-section">
                <h4>Best Selling Items</h4>
                <div class="products-list">
                  <div 
                    *ngFor="let product of bestSellerProducts(); let i = index"
                    (click)="addToCart(product)"
                    class="product-list-item bestseller"
                    [class.disabled]="!canInteractWithProducts()">
                    <div class="rank-badge">{{ i + 1 }}</div>
                    <img 
                      [src]="product.imageUrl || 'assets/noimage.png'"
                      [alt]="product.productName"
                      class="product-image-small"
                      onerror="this.src='assets/noimage.png'">
                    <div class="product-info">
                      <h4>{{ product.productName }}</h4>
                      <p class="product-sku">{{ product.skuId }}</p>
                    </div>
                    <div class="product-price">‚Ç±{{ (product.sellingPrice || 0).toFixed(2) }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Orders results use the same display area when Orders tab is active -->
          <div class="products-display" *ngIf="accessTab() === 'Orders'" style="padding:1rem;">
            <!-- Control buttons for Orders tab -->
            <div style="margin-bottom: 1rem;">
              <!-- Refresh button -->
              <button 
                (click)="refreshOrders()" 
                [disabled]="isLoadingOrders()"
                style="background: #059669; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;"
                [style.opacity]="isLoadingOrders() ? '0.6' : '1'"
                [style.cursor]="isLoadingOrders() ? 'not-allowed' : 'pointer'">
                <span *ngIf="!isLoadingOrders()">üîÑ</span>
                <span *ngIf="isLoadingOrders()">‚è≥</span>
                {{ isLoadingOrders() ? 'Refreshing...' : 'Refresh Orders' }}
              </button>
            </div>
            
            <div *ngIf="isLoadingOrders()" class="muted" style="text-align: center; padding: 2rem;">
              <div style="margin-bottom: 1rem;">üîÑ Loading orders...</div>
              <div style="font-size: 0.8rem; color: #6b7280;">Fetching recent orders from database</div>
            </div>
            
            <div *ngIf="!isLoadingOrders() && orders().length === 0 && orderSearchQuery()" class="muted">
              No orders found for "{{ orderSearchQuery() }}"
            </div>
            <div *ngIf="!isLoadingOrders() && orders().length === 0 && !orderSearchQuery()" class="muted">
              No recent orders available. Orders will appear here once you start processing transactions.
            </div>
            
            <!-- Enhanced Order List Display -->
            <div class="orders-list" *ngIf="!isLoadingOrders() && orders().length > 0">
              <div class="orders-header" style="display: grid; grid-template-columns: 2fr 1fr 2fr 1fr; gap: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                <div>Invoice Number</div>
                <div>Date</div>
                <div>Customer Name</div>
                <div style="text-align: right;">Amount</div>
              </div>
              
              <div *ngFor="let order of orders()" 
                   class="order-list-item" 
                   (dblclick)="openOrder(order)" 
                   style="display: grid; grid-template-columns: 2fr 1fr 2fr 1fr; gap: 1rem; padding: 0.75rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background-color 0.2s;"
                   onmouseover="this.style.backgroundColor='#f8fafc'"
                   onmouseout="this.style.backgroundColor='transparent'">
                
                <!-- Invoice Number -->
                <div class="order-invoice" style="font-weight: 600; color: #1f2937;">
                  {{ order.invoiceNumber || order.id || 'N/A' }}
                  <div *ngIf="order.businessAddress" style="font-size: 0.8rem; color: #6b7280; font-weight: 400; margin-top: 2px;">
                    üìç {{ order.businessAddress }}
                  </div>
                </div>
                
                <!-- Date -->
                <div class="order-date" style="color: #6b7280; font-size: 0.9rem;">
                  {{ order.date ? (order.date | date:'MMM d, y') : (order.createdAt | date:'MMM d, y') }}
                  <div style="font-size: 0.8rem; color: #9ca3af;">
                    {{ order.date ? (order.date | date:'shortTime') : (order.createdAt | date:'shortTime') }}
                  </div>
                </div>
                
                <!-- Customer Name -->
                <div class="order-customer" style="color: #374151;">
                  <div style="font-weight: 500;">
                    {{ order.soldTo || 'Walk-in Customer' }}
                  </div>
                  <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">
                    Status: <span [style.color]="getOrderStatusColor(order.status)">{{ order.status | titlecase }}</span>
                  </div>
                </div>
                
                <!-- Amount -->
                <div class="order-amount" style="text-align: right;">
                  <div style="font-weight: 700; color: #059669; font-size: 1.1rem;">
                    {{ order.totalAmount | currency:'PHP':'symbol':'1.2-2' }}
                  </div>
                  <div style="font-size: 0.8rem; color: #6b7280;">
                    {{ order.cashSale ? 'Cash' : 'Charge' }}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Search Results Summary -->
            <div *ngIf="!isLoadingOrders() && orders().length > 0" class="search-summary" style="margin-top: 1rem; padding: 0.5rem; background: #ecfdf5; border-left: 4px solid #10b981; color: #065f46; font-size: 0.9rem;">
              {{ orderSearchQuery() ? 'Found ' + orders().length + ' order(s) for "' + orderSearchQuery() + '"' : 'Showing ' + orders().length + ' recent order(s)' }}
            </div>
          </div>
        </div>

       

        <!-- Order detail modal -->
        <div *ngIf="selectedOrder()" class="modal-backdrop" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:40;">
          <div class="modal" style="background:white; padding:1.5rem; width:600px; max-width:90vw; border-radius:8px; max-height:80vh; overflow-y:auto;">
            <h3 style="margin-bottom: 1rem; color: #1f2937;">Order Details</h3>
            
            <!-- Order Header Information -->
            <div class="order-header-info" style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <div style="font-weight: 600; color: #374151;">Invoice Number</div>
                  <div style="color: #6b7280;">{{ selectedOrder()?.invoiceNumber || selectedOrder()?.id || 'N/A' }}</div>
                </div>
                <div>
                  <div style="font-weight: 600; color: #374151;">Date</div>
                  <div style="color: #6b7280;">{{ selectedOrder()?.date ? (selectedOrder()?.date | date:'full') : (selectedOrder()?.createdAt | date:'full') }}</div>
                </div>
                <div>
                  <div style="font-weight: 600; color: #374151;">Customer</div>
                  <div style="color: #6b7280;">{{ selectedOrder()?.soldTo || 'Walk-in Customer' }}</div>
                </div>
                <div>
                  <div style="font-weight: 600; color: #374151;">Status</div>
                  <div [style.color]="getOrderStatusColor(selectedOrder()?.status)" style="font-weight: 500;">{{ selectedOrder()?.status | titlecase }}</div>
                </div>
              </div>
              
              <!-- Customer Address if available -->
              <div *ngIf="selectedOrder()?.businessAddress" style="margin-top: 0.75rem;">
                <div style="font-weight: 600; color: #374151;">Business Address</div>
                <div style="color: #6b7280;">{{ selectedOrder()?.businessAddress }}</div>
              </div>
              
              <!-- Store and Total Amount -->
              <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; margin-top: 0.75rem; align-items: center;">
                <div>
                  <div style="font-weight: 600; color: #374151;">Store</div>
                  <div style="color: #6b7280;">{{ selectedOrder()?.storeId || 'Global' }}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: 600; color: #374151;">{{ 'pos.total' | translate }} {{ 'pos.amount' | translate }}</div>
                  <div style="font-weight: 700; font-size: 1.25rem; color: #059669;">{{ selectedOrder()?.totalAmount | currency:'PHP':'symbol':'1.2-2' }}</div>
                </div>
              </div>
            </div>
            
            <!-- Order Items -->
            <div style="margin-bottom: 1rem;">
              <h4 style="margin-bottom: 0.5rem; color: #374151;">Order Items</h4>
              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
                <div *ngFor="let item of selectedOrder()?.items; let i = index; let last = last" 
                     style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;"
                     [style.border-bottom]="last ? 'none' : '1px solid #f3f4f6'">
                  
                  <!-- Item Info Row -->
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <div>
                      <div style="font-weight: 500;">{{ item.name || item.productName }}</div>
                      <div style="font-size: 0.85rem; color: #6b7280;">
                        Quantity: {{ item.quantity }} | Unit Price: {{ item.price | currency:'PHP':'symbol':'1.2-2' }}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-weight: 600;">{{ (item.price * item.quantity) | currency:'PHP':'symbol':'1.2-2' }}</div>
                      <div style="font-size: 0.85rem; color: #6b7280;">{{ 'pos.total' | translate }}</div>
                    </div>
                  </div>
                  
                  <!-- Item Action Buttons -->
                  <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                    <button class="item-action-btn return-btn" 
                            (click)="processItemAction(selectedOrder()?.id, i, 'return', item)"
                            title="Return Item">
                      ‚Ü©Ô∏è Return
                    </button>
                    <button class="item-action-btn damage-btn" 
                            (click)="processItemAction(selectedOrder()?.id, i, 'damage', item)"
                            title="Mark as Damaged">
                      üí• Damage
                    </button>
                    <button class="item-action-btn refund-btn" 
                            (click)="processItemAction(selectedOrder()?.id, i, 'refund', item)"
                            title="Refund Item">
                      üí∞ Refund
                    </button>
                    <button class="item-action-btn cancel-btn" 
                            (click)="processItemAction(selectedOrder()?.id, i, 'cancel', item)"
                            title="Cancel Item">
                      ‚ùå Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap;">
              <button class="btn btn-secondary" (click)="closeOrder()">Close</button>
              <button class="btn" style="background: #059669; color: white;" (click)="openOrderReceipt(selectedOrder())">
                üìÑ Open Receipt
              </button>
              <button *ngIf="selectedOrder()?.status !== 'cancelled'" class="btn" style="background: #f97316; color: white;" (click)="updateOrderStatus(selectedOrder()?.id, 'cancelled')">Cancel Order</button>
              <button *ngIf="selectedOrder()?.status !== 'refunded'" class="btn btn-primary" (click)="updateOrderStatus(selectedOrder()?.id, 'refunded')">Process Refund</button>
            </div>
          </div>
        </div>

        <!-- Right Panel: Receipt/Cart -->
        <div class="right-panel">
          <div class="receipt-panel">
            <!-- Receipt Header -->
            <!-- <div class="receipt-header">
              <div class="company-info">
                <h2>{{ currentStoreInfo()?.storeName || 'Store Name' }}</h2>
                <p>{{ currentStoreInfo()?.storeName || 'Store Name' }}</p>
                <p>{{ currentStoreInfo()?.address || 'Store Address' }}</p>
                <p>{{ currentStoreInfo()?.phoneNumber || 'Contact Number' }}</p>
                <p>{{ currentStoreInfo()?.email || 'Email Address' }}</p>
                <p class="receipt-date">{{ currentDate | date:'medium' }}</p>
              </div>
            </div> -->

            <!-- Hotkey Hints (clickable) -->
            <fieldset class="hotkey-fieldset">
              <legend>Shortcut keys</legend>
              <div class="hotkey-hints">
                <div class="hotkey-item" (click)="handleF4HotkeyClick()" title="F4 - {{ 'pos.clearCart' | translate }}">
                  <kbd>F4</kbd>
                  <span>{{ 'pos.clearCart' | translate }}</span>
                </div>
                <div class="hotkey-item" (click)="handleF5HotkeyClick()" title="F5 - {{ 'pos.newOrder' | translate }}">
                  <kbd>F5</kbd>
                  <span>{{ 'pos.newOrder' | translate }}</span>
                </div>
                <div class="hotkey-item" (click)="handleF6HotkeyClick()" title="F6 - {{ 'pos.completeOrder' | translate }}">
                  <kbd>F6</kbd>
                  <span>{{ 'pos.completeOrder' | translate }}</span>
                </div>
                <div class="hotkey-item" (click)="handleF7HotkeyClick()" title="F7 - {{ 'pos.addDiscount' | translate }}">
                  <kbd>F7</kbd>
                  <span>{{ 'pos.addDiscount' | translate }}</span>
                </div>
              </div>
            </fieldset>

            <!-- Invoice Info moved OUTSIDE cart scroll to stay steady -->
            <fieldset class="invoice-fieldset">
              <legend>{{ 'pos.invoiceInformation' | translate }}</legend>
              <div class="invoice-compact-layout">
                <div class="invoice-field-compact">
                  <label>{{ 'pos.invoiceNumber' | translate }}:</label>
                  <input type="text" [(ngModel)]="invoiceNumber" placeholder="Auto-generated">
                </div>
                <div class="invoice-field-compact">
                  <label>{{ 'pos.dateTime' | translate }}:</label>
                  <input type="datetime-local" [(ngModel)]="datetime">
                </div>
              </div>
            </fieldset>

            <!-- Cart Header moved OUTSIDE scroll so it stays steady -->
            <div class="cart-header">
              <span>{{ 'pos.product' | translate }}</span>
              <span>{{ 'pos.quantity' | translate }}</span>
              <span>{{ 'pos.price' | translate }}</span>
              <span>{{ 'pos.total' | translate }}</span>
            </div>

            <!-- Cart Items (scrolls independently) -->
            <div class="cart-items">
              
              <div *ngIf="cartItems().length === 0" class="empty-cart">
                <p>{{ 'pos.cartEmpty' | translate }}</p>
              </div>

              <div 
                *ngFor="let item of cartItemsLatestFirst()" 
                class="cart-item">
                <div class="item-details">
                  <span class="item-name">{{ item.productName }}</span>
                  <span class="item-sku">{{ item.skuId }}</span>
                </div>
                <div class="quantity-controls">
                  <button (click)="updateQuantity(item.productId, item.quantity - 1)" class="qty-btn">-</button>
                  <span class="quantity">{{ item.quantity }}</span>
                  <button (click)="updateQuantity(item.productId, item.quantity + 1)" class="qty-btn">+</button>
                </div>
                <div class="item-price">{{ item.sellingPrice.toFixed(2) }}</div>
                <div class="item-total">
                  {{ item.total.toFixed(2) }}
                  <button (click)="removeFromCart(item.productId)" class="remove-btn">√ó</button>
                </div>
              </div>
            </div>

            <!-- Receipt Summary -->
            <div class="receipt-summary">
              <div class="summary-line">
                <span>{{ 'pos.vatableSales' | translate }}:</span>
                <span>‚Ç±{{ cartSummary().vatableSales.toFixed(2) }}</span>
              </div>
              <div class="summary-line">
                <span>{{ 'pos.vatExemptSales' | translate }}:</span>
                <span>‚Ç±{{ cartSummary().vatExemptSales.toFixed(2) }}</span>
              </div>
              <div class="summary-line">
                <span>{{ 'pos.vatAmount' | translate }}:</span>
                <span>‚Ç±{{ cartSummary().vatAmount.toFixed(2) }}</span>
              </div>
              <div class="summary-line" *ngIf="cartSummary().zeroRatedSales > 0">
                <span>Zero-Rated Sales:</span>
                <span>‚Ç±{{ cartSummary().zeroRatedSales.toFixed(2) }}</span>
              </div>
              <div class="summary-line" *ngIf="cartSummary().productDiscountAmount > 0">
                <span>{{ 'pos.productDiscounts' | translate }}:</span>
                <span>-‚Ç±{{ cartSummary().productDiscountAmount.toFixed(2) }}</span>
              </div>
              <div class="summary-line">
                <span>{{ 'pos.grossAmount' | translate }}:</span>
                <span>‚Ç±{{ cartSummary().grossAmount.toFixed(2) }}</span>
              </div>
              
              <!-- Order Discount Section -->
              <div class="order-discount-section" *ngIf="orderDiscount() || cartItems().length > 0">
                <div class="summary-line" *ngIf="orderDiscount()">
                  <span>{{ getDiscountDisplayName() }}:</span>
                  <span>-‚Ç±{{ cartSummary().orderDiscountAmount.toFixed(2) }}</span>
                  <button (click)="removeOrderDiscount()" class="remove-discount-btn">√ó</button>
                </div>
                <button 
                  *ngIf="!orderDiscount() && (cartItems().length > 0 || isNewOrderActive())" 
                  (click)="showDiscountModal()" 
                  [disabled]="isOrderCompleted()"
                  class="btn btn-discount">
                  {{ 'pos.addDiscount' | translate }}
                </button>
              </div>
              
              <div class="summary-line total">
                <span>{{ 'pos.netAmount' | translate }}:</span>
                <span>‚Ç±{{ cartSummary().netAmount.toFixed(2) }}</span>
              </div>
            </div>

            <!-- New Order Section -->
            <div class="new-order-section">
              <button 
                (click)="startNewOrder()" 
                class="btn btn-new-order"
                [class.active]="isNewOrderActive()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" style="vertical-align: middle; margin-right: 6px;">
                  <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 5v4h4v2h-4v4h-2v-4H7v-2h4V7h2z"/>
                </svg>
                {{ 'pos.newOrder' | translate }}
              </button>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <button 
                (click)="clearCart()" 
                [disabled]="!canClearCart()"
                class="btn btn-gradient">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m5 5v6m4-6v6"/>
                </svg>
                {{ 'pos.clearCart' | translate }}
              </button>
              <button 
                (click)="processOrder()" 
                [disabled]="cartItems().length === 0 || isProcessing()"
                class="btn btn-primary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" style="vertical-align: middle; margin-right: 6px;">
                  <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm-1 13.17-3.59-3.58 1.41-1.42L11 12.34l4.17-4.17 1.41 1.41L11 15.17z"/>
                </svg>
                {{ completeOrderButtonText() | translate }}
              </button>
            </div>

            <!-- Receipt Footer -->
            <div class="receipt-footer">
              <p>Thank you! See you again!</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Receipt Modal -->
    <app-receipt 
      [isVisible]="isReceiptModalVisible()"
      [receiptData]="receiptData()"
      (closeModal)="closeReceiptModal()"
      (printReceipt)="printReceipt()">
    </app-receipt>

    <!-- Discount Modal -->
    <app-discount-modal 
      *ngIf="isDiscountModalVisible()"
      (discountApplied)="applyOrderDiscount($event)"
      (modalClosed)="closeDiscountModal()">
    </app-discount-modal>

    <!-- Confirmation Dialog -->
    <app-confirmation-dialog 
      *ngIf="isConfirmationDialogVisible() && confirmationDialogData()"
      [dialogData]="confirmationDialogData()!"
      (confirmed)="onConfirmationConfirmed()"
      (cancelled)="onConfirmationCancelled()">
    </app-confirmation-dialog>

    <!-- Offline Invoice Preference Dialog -->
    <div *ngIf="showOfflineInvoiceDialog()" class="modal-overlay">
      <div class="offline-invoice-dialog">
        <div class="dialog-header">
          <h3>üîÑ System is Offline</h3>
          <p>The system is offline. Would you like to manually input the invoice number?</p>
        </div>
        
        <div class="dialog-content">
          <div class="radio-group">
            <div class="radio-option">
              <input 
                type="radio" 
                id="manual-invoice" 
                name="invoice-preference" 
                value="manual"
                [checked]="offlineInvoicePreference() === 'manual'"
                (change)="onInvoicePreferenceChange('manual')">
              <label for="manual-invoice">Manually input invoice number</label>
            </div>
            
            <div class="manual-input-section" *ngIf="offlineInvoicePreference() === 'manual'">
              <input 
                type="text" 
                placeholder="INV-0000-000000"
                [(ngModel)]="manualInvoiceInput"
                class="invoice-input"
                autocomplete="off"
                spellcheck="false">
            </div>
            
            <div class="radio-option">
              <input 
                type="radio" 
                id="auto-invoice" 
                name="invoice-preference" 
                value="auto"
                [checked]="offlineInvoicePreference() === 'auto'"
                (change)="onInvoicePreferenceChange('auto')">
              <label for="auto-invoice">Proceed with current invoice number + 1</label>
            </div>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button 
            type="button"
            class="btn-secondary"
            (click)="onOfflineInvoiceCancelled()">
            Cancel
          </button>
          <button 
            type="button"
            class="btn-primary"
            (click)="onOfflineInvoiceOk()">
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- Payment Dialog -->
    <div *ngIf="showPaymentModal()" class="modal-overlay">
      <div class="payment-dialog">
        <div class="dialog-header">
          <h3>üí≥ {{ 'pos.paymentProcessing' | translate }}</h3>
          <p>{{ 'pos.enterPaymentDetails' | translate }}</p>
        </div>
        
        <div class="dialog-content">
          <div class="payment-amounts">
            <div class="amount-field">
              <label for="total-amount">{{ 'pos.totalAmountDue' | translate }}:</label>
              <input 
                type="text" 
                id="total-amount"
                [value]="'‚Ç±' + cartSummary().netAmount.toFixed(2)"
                readonly
                class="amount-input readonly">
            </div>
            
            <div class="amount-field">
              <label for="amount-tendered">{{ 'pos.amountTendered' | translate }}:</label>
              <input 
                type="number" 
                id="amount-tendered"
                [(ngModel)]="paymentAmountTendered"
                placeholder="0.00"
                step="0.01"
                class="amount-input"
                (click)="debugTenderedField()"
                (focus)="debugTenderedField()"
                [disabled]="false">
            </div>
            
            <div class="amount-field">
              <label for="change-amount">{{ 'pos.change' | translate }}:</label>
              <input 
                type="text" 
                id="change-amount"
                [value]="'‚Ç±' + calculateChange().toFixed(2)"
                readonly
                class="amount-input readonly">
            </div>
          </div>
          
          <div class="payment-description">
            <label for="payment-desc">{{ 'pos.paymentDescription' | translate }}:</label>
            <textarea 
              id="payment-desc"
              [(ngModel)]="paymentDescription"
              [placeholder]="'pos.paymentDescriptionPlaceholder' | translate"
              rows="3"
              class="payment-textarea"></textarea>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button 
            type="button"
            class="btn-secondary"
            (click)="closePaymentDialog()">
            {{ 'buttons.cancel' | translate }}
          </button>
          <button 
            type="button"
            class="btn-primary"
            (click)="processPayment()">
            {{ 'pos.processPayment' | translate }}
          </button>
        </div>
      </div>
    </div>