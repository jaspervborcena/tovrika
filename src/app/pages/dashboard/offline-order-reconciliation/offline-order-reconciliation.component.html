<div class="offline-reconciliation-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Offline Order Reconciliation</h1>
        <p class="page-subtitle">Find and fix orders with missing inventory deductions or ledger entries</p>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="date-picker-section">
      
      <!-- Store Selection -->
      <div class="store-selection">
        <div class="store-selector">
          <label for="storeSelect">Store:</label>
          <select 
            id="storeSelect"
            [(ngModel)]="selectedStoreId"
            class="store-select">
            <option *ngFor="let store of stores" [value]="store.id">
              {{ store.storeName.toUpperCase() }}
            </option>
          </select>
        </div>
      </div>
      
      <div class="date-inputs">
        <div class="date-input-group">
          <label for="fromDate">From Date:</label>
          <input 
            type="date" 
            id="fromDate"
            [(ngModel)]="startDate"
            class="date-input">
        </div>
        <div class="date-input-group">
          <label for="toDate">To Date:</label>
          <input 
            type="date" 
            id="toDate"
            [(ngModel)]="endDate"
            class="date-input">
        </div>
        <div class="go-button-group">
          <button 
            (click)="searchDiscrepancies()"
            [disabled]="loading"
            class="go-button">
            <span *ngIf="!loading">Go</span>
            <span *ngIf="loading" class="loading-text">Loading...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Filters Row -->
    <div class="additional-filters">
      <div class="filter-group">
        <label for="severityFilter">Severity:</label>
        <select 
          id="severityFilter"
          [(ngModel)]="severityFilter"
          class="filter-select-small">
          <option value="all">All</option>
          <option value="critical">Critical</option>
          <option value="warning">Warning</option>
          <option value="info">Info</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="checkbox-label">
          <input 
            type="checkbox"
            [(ngModel)]="offlineOnlyFilter"
            class="checkbox-input" />
          <span>Offline Orders Only</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div *ngIf="summary" class="summary-cards">
    <div class="summary-cards-grid">
      <div class="summary-card">
        <div class="text-sm text-gray-600 mb-1">Total Discrepancies</div>
        <div class="text-3xl font-bold text-gray-800">{{ summary.ordersWithDiscrepancies }}</div>
      </div>

      <div class="summary-card bg-red-50">
        <div class="text-sm text-red-600 mb-1 font-medium">Critical Issues</div>
        <div class="text-3xl font-bold text-red-700">{{ summary.criticalIssues }}</div>
      </div>

      <div class="summary-card bg-yellow-50">
        <div class="text-sm text-yellow-600 mb-1 font-medium">Warnings</div>
        <div class="text-3xl font-bold text-yellow-700">{{ summary.warningIssues }}</div>
      </div>

      <div class="summary-card bg-blue-50">
        <div class="text-sm text-blue-600 mb-1 font-medium">Amount Discrepancy</div>
        <div class="text-3xl font-bold text-blue-700">‚Ç±{{ summary.totalAmountDiscrepancy.toFixed(2) }}</div>
      </div>
    </div>
  </div>

  <!-- Results Table -->
  <div *ngIf="filteredDiscrepancies.length > 0" class="table-container">
    <div class="table-wrapper">
      <table class="discrepancies-table">
        <thead>
          <tr>
            <th>Invoice</th>
            <th>Date</th>
            <th>Cashier</th>
            <th>Severity</th>
            <th>Issues</th>
            <th style="text-align: right;">Tracking</th>
            <th style="text-align: right;">Ledger</th>
            <th style="text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let disc of filteredDiscrepancies">
            <td>
              <div class="font-medium text-gray-900">{{ disc.invoiceNumber }}</div>
              <div *ngIf="disc.isOfflineOrder" class="text-xs text-orange-600 font-medium mt-1">üì¥ Offline</div>
            </td>
            <td class="text-sm text-gray-600">
              {{ disc.orderDate | date:'short' }}
            </td>
            <td class="text-sm text-gray-600">
              {{ disc.cashierName }}
            </td>
            <td>
              <span [class]="'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + getSeverityBgColor(disc.severity) + ' ' + getSeverityColor(disc.severity)">
                {{ disc.severity }}
              </span>
            </td>
            <td class="text-sm">
              <div *ngIf="!disc.inventoryProcessed" class="text-red-600 mb-1">‚ùå No Inventory</div>
              <div *ngIf="!disc.ledgerExists" class="text-red-600 mb-1">‚ùå No Ledger</div>
              <div *ngIf="disc.fifoSkipped" class="text-yellow-600">‚ö†Ô∏è FIFO Skipped</div>
            </td>
            <td style="text-align: right;">
              <div class="text-sm font-medium text-gray-900">‚Ç±{{ disc.trackingAmount.toFixed(2) }}</div>
              <div class="text-xs text-gray-500">{{ disc.trackingQuantity }} items</div>
            </td>
            <td style="text-align: right;">
              <div *ngIf="disc.ledgerExists" class="text-sm font-medium text-gray-900">‚Ç±{{ disc.ledgerAmount?.toFixed(2) }}</div>
              <div *ngIf="!disc.ledgerExists" class="text-sm font-medium text-red-600">Missing</div>
              <div *ngIf="disc.ledgerExists && Math.abs(disc.amountDiscrepancy) > 0.01" class="text-xs text-red-600">
                Œî ‚Ç±{{ Math.abs(disc.amountDiscrepancy).toFixed(2) }}
              </div>
            </td>
            <td style="text-align: center;">
              <button 
                (click)="viewDetails(disc)"
                class="view-details-btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
                View Details
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- No Results -->
  <div *ngIf="!loading && discrepancies.length === 0 && summary" class="table-container">
    <div class="no-results">
      <div class="text-gray-400 text-6xl mb-4">‚úì</div>
      <h3 class="text-xl font-semibold text-gray-700 mb-2">No Discrepancies Found</h3>
      <p class="text-gray-500">All orders in this date range have been properly processed.</p>
    </div>
  </div>

  <!-- Detail Modal -->
  <div *ngIf="showDetailModal && selectedDiscrepancy" 
       class="modal-overlay"
       (click)="closeDetailModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <h3>üìã Reconciliation Details</h3>
        <button class="close-btn" (click)="closeDetailModal()">√ó</button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- Order Information -->
        <div class="form-section">
          <h4 class="section-title">
            <span>üìù</span>
            <span>Order Information</span>
          </h4>
          <div class="order-info">
            <div class="info-row">
              <span class="info-label">Invoice Number:</span>
              <span class="info-value">{{ selectedDiscrepancy.invoiceNumber }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Date:</span>
              <span class="info-value">{{ selectedDiscrepancy.orderDate | date:'medium' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Cashier:</span>
              <span class="info-value">{{ selectedDiscrepancy.cashierName }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Order Type:</span>
              <span class="info-value">{{ selectedDiscrepancy.isOfflineOrder ? 'üì¥ Offline' : 'üåê Online' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Severity:</span>
              <span class="info-value">
                <span [class]="'status-badge status-' + selectedDiscrepancy.severity">
                  {{ selectedDiscrepancy.severity }}
                </span>
              </span>
            </div>
          </div>
        </div>

        <!-- Status Section -->
        <div class="form-section">
          <h4 class="section-title">
            <span>üìä</span>
            <span>Processing Status</span>
          </h4>
          <div class="order-info">
            <div class="info-row">
              <span class="info-label">Inventory Processed:</span>
              <span class="info-value">
                <span [class]="selectedDiscrepancy.inventoryProcessed ? 'text-success' : 'text-danger'">
                  {{ selectedDiscrepancy.inventoryProcessed ? '‚úì Yes' : '‚úó No' }}
                </span>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Ledger Entry:</span>
              <span class="info-value">
                <span [class]="selectedDiscrepancy.ledgerExists ? 'text-success' : 'text-danger'">
                  {{ selectedDiscrepancy.ledgerExists ? '‚úì Exists' : '‚úó Missing' }}
                </span>
              </span>
            </div>
            <div *ngIf="selectedDiscrepancy.fifoSkipped" class="info-row">
              <span class="info-label">FIFO Status:</span>
              <span class="info-value text-warning">‚ö†Ô∏è Skipped</span>
            </div>
          </div>
        </div>

        <!-- Transaction Details -->
        <div class="form-section">
          <h4 class="section-title">
            <span>üí∞</span>
            <span>Transaction Details</span>
          </h4>
          <div class="order-info">
            <div class="info-row">
              <span class="info-label">Tracking Amount:</span>
              <span class="info-value">‚Ç±{{ selectedDiscrepancy.trackingAmount.toFixed(2) }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Tracking Quantity:</span>
              <span class="info-value">{{ selectedDiscrepancy.trackingQuantity }} items</span>
            </div>
            <div class="info-row">
              <span class="info-label">Ledger Amount:</span>
              <span class="info-value">
                <span *ngIf="selectedDiscrepancy.ledgerExists">‚Ç±{{ selectedDiscrepancy.ledgerAmount?.toFixed(2) }}</span>
                <span *ngIf="!selectedDiscrepancy.ledgerExists" class="text-danger">Missing</span>
              </span>
            </div>
            <div class="info-row" *ngIf="Math.abs(selectedDiscrepancy.amountDiscrepancy) > 0.01">
              <span class="info-label">Amount Discrepancy:</span>
              <span class="info-value text-danger">‚Ç±{{ Math.abs(selectedDiscrepancy.amountDiscrepancy).toFixed(2) }}</span>
            </div>
          </div>
        </div>

        <!-- Recommended Actions -->
        <div class="form-section">
          <h4 class="section-title">
            <span>üîß</span>
            <span>Recommended Actions</span>
          </h4>
          <div class="actions-list">
            <div *ngFor="let action of selectedDiscrepancy.reconciliationActions" class="action-item">
              <div class="action-header">
                <span class="action-title">{{ action.type.replace('_', ' ') | titlecase }}</span>
                <span [class]="'risk-badge risk-' + action.riskLevel">
                  {{ action.riskLevel }}
                </span>
              </div>
              <div class="action-description">{{ action.description }}</div>
              <div class="action-duration">‚è±Ô∏è {{ action.estimatedDuration }}</div>
            </div>
          </div>
        </div>

        <!-- Processing Message -->
        <div *ngIf="processing" class="processing-message">
          {{ processingMessage }}
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button 
          *ngIf="selectedDiscrepancy.needsInventoryReprocess"
          (click)="reprocessInventory(selectedDiscrepancy)"
          [disabled]="processing"
          class="btn btn-primary">
          Reprocess Inventory
        </button>

        <button 
          *ngIf="selectedDiscrepancy.needsLedgerCreation"
          (click)="createLedgerEntry(selectedDiscrepancy)"
          [disabled]="processing"
          class="btn btn-primary">
          Create Ledger Entry
        </button>

        <button 
          (click)="markReconciled(selectedDiscrepancy)"
          [disabled]="processing"
          class="btn btn-secondary">
          Mark Reconciled
        </button>

        <button 
          class="btn btn-secondary" 
          (click)="closeDetailModal()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Dialog -->
<app-confirmation-dialog 
  *ngIf="showConfirmDialog() && confirmDialogData()" 
  [dialogData]="confirmDialogData()!" 
  (confirmed)="onConfirmed()" 
  (cancelled)="onCancelled()">
</app-confirmation-dialog>
