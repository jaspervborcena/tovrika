<div class="inventory-container">
  <!-- Header (patterned after Sales Summary) -->
  <div class="header">
    <div class="header-content">
      <h1 class="page-title">Inventory</h1>
      <p class="page-subtitle">View and analyze your inventory performance</p>
    </div>
  </div>
  <!-- Controls: Store + Period (select) - patterned after Overview -->
  <div class="overview-controls">
    <div class="control-row">
      <label class="control-label">Store</label>
      
      <!-- Multiple stores: Show dropdown -->
      <select 
        *ngIf="hasMultipleStores(); else singleStore"
        class="control-select" 
        [(ngModel)]="selectedStoreId" 
        (change)="onStoreChange()">
        <option *ngFor="let store of stores()" [value]="store.id">
          {{ store.storeName.toUpperCase() }}
        </option>
      </select>
      
      <!-- Single store: Show static name -->
      <ng-template #singleStore>
        <div class="single-store">
          <span class="store-name">{{ getSelectedStoreName() }}</span>
        </div>
      </ng-template>
    </div>

    <div class="control-row">
      <label class="control-label">Period</label>
      <select class="control-select" [(ngModel)]="selectedPeriod" (change)="onPeriodChange($event)">
        <option *ngFor="let p of periodOptions" [value]="p.key">{{ p.label }}</option>
      </select>

      <div *ngIf="selectedPeriod === 'date_range'" class="date-range-inputs">
        <input type="date" class="control-input" [(ngModel)]="dateFrom" />
        <input type="date" class="control-input" [(ngModel)]="dateTo" />
        <button class="control-go" (click)="onApplyDateRange()">Go</button>
      </div>
    </div>
  </div>

  <div class="table-wrap mat-elevation">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">

      <!-- Date (without time) -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Date </th>
        <td mat-cell *matCellDef="let row"> {{row.date | date:'M/d/yy'}} </td>
      </ng-container>

      <!-- Product Name -->
      <ng-container matColumnDef="productName">
        <th mat-header-cell *matHeaderCellDef> Product Name </th>
        <td mat-cell *matCellDef="let row"> {{row.productName || '-'}} </td>
      </ng-container>

      <!-- Product Code -->
      <ng-container matColumnDef="productCode">
        <th mat-header-cell *matHeaderCellDef> Product Code </th>
        <td mat-cell *matCellDef="let row"> {{row.productCode}} </td>
      </ng-container>

      <!-- SKU -->
      <ng-container matColumnDef="sku">
        <th mat-header-cell *matHeaderCellDef> SKU </th>
        <td mat-cell *matCellDef="let row"> {{row.sku}} </td>
      </ng-container>

      <!-- Cost Price -->
      <ng-container matColumnDef="costPrice">
        <th mat-header-cell *matHeaderCellDef> Cost Price </th>
        <td mat-cell *matCellDef="let row"> {{row.costPrice | number:'1.2-2'}} </td>
      </ng-container>

      <!-- Selling Price -->
      <ng-container matColumnDef="sellingPrice">
        <th mat-header-cell *matHeaderCellDef> Selling Price </th>
        <td mat-cell *matCellDef="let row"> {{row.sellingPrice | number:'1.2-2'}} </td>
      </ng-container>

      <!-- Quantity -->
      <ng-container matColumnDef="quantity">
        <th mat-header-cell *matHeaderCellDef> Quantity </th>
        <td mat-cell *matCellDef="let row"> {{row.quantity}} </td>
      </ng-container>

      <!-- Profit Per Unit -->
      <ng-container matColumnDef="profitPerUnit">
        <th mat-header-cell *matHeaderCellDef> Profit/Unit </th>
        <td mat-cell *matCellDef="let row"> {{row.profitPerUnit | number:'1.2-2'}} </td>
      </ng-container>

      <!-- Beginning Stock -->
      <ng-container matColumnDef="runningBalanceTotalStock">
        <th mat-header-cell *matHeaderCellDef> Beginning Stock </th>
        <td mat-cell *matCellDef="let row"> {{row.runningBalanceTotalStock || 0}} </td>
      </ng-container>

      <!-- Remaining Stock -->
      <ng-container matColumnDef="remainingStock">
        <th mat-header-cell *matHeaderCellDef> Remaining Stock </th>
        <td mat-cell *matCellDef="let row"> {{row.remainingStock || 0}} </td>
      </ng-container>

      <!-- Total Gross -->
      <ng-container matColumnDef="totalGross">
        <th mat-header-cell *matHeaderCellDef> Total Gross </th>
        <td mat-cell *matCellDef="let row"> ‚Ç±{{row.totalGross | number:'1.2-2'}} </td>
      </ng-container>

      <!-- Total Profit -->
      <ng-container matColumnDef="totalProfit">
        <th mat-header-cell *matHeaderCellDef> Total Profit </th>
        <td mat-cell *matCellDef="let row"> ‚Ç±{{row.totalProfit | number:'1.2-2'}} </td>
      </ng-container>

      <!-- Actions: View Details -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Actions </th>
        <td mat-cell *matCellDef="let row">
          <button 
            mat-button 
            color="primary" 
            (click)="openDetails(row)"
            style="font-size: 0.875rem;">
            View Details
          </button>
        </td>
      </ng-container>

      <!-- Render rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>
  <!-- Empty state when no rows for selected period -->
  <div *ngIf="!inventoryService.isLoading() && dataSource.data.length === 0" style="padding:24px; text-align:center; color:#718096;">
    <div style="font-size:1.25rem; margin-bottom:8px;">No data for the selected period</div>
    <div style="margin-bottom:12px;">Try a different period or refresh.</div>
  </div>

  <!-- Pagination controls -->
  <div *ngIf="inventoryService.totalCount() > 0" class="pagination" style="display:flex; gap:8px; align-items:center; margin-top:12px;">
    <button (click)="goToPage(inventoryService.currentPage() - 1)" [disabled]="inventoryService.currentPage() === 1">Prev</button>

    <ng-container *ngFor="let p of pagesToShow()">
      <button *ngIf="p !== '...'" (click)="goToPage(p)" [class.active]="(inventoryService.currentPage() === p)" style="min-width:36px;">
        {{ p }}
      </button>
      <span *ngIf="p === '...'" style="padding:0 8px;">‚Ä¶</span>
    </ng-container>

    <button (click)="goToPage(inventoryService.currentPage() + 1)" [disabled]="inventoryService.currentPage() === inventoryService.totalPages()">Next</button>

    <div style="margin-left:auto; color:#6b7280; font-size:0.9rem;">
      Showing page {{ inventoryService.currentPage() }} of {{ inventoryService.totalPages() }} ‚Äî total {{ inventoryService.totalCount() }} rows
    </div>
  </div>

  <!-- Details Modal -->
  <div *ngIf="showDetails()" 
       class="modal-overlay" 
       (click)="closeDetails()"
       style="position: fixed !important; z-index: 9999 !important; background: rgba(0, 0, 0, 0.8) !important; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
    <div class="modal" (click)="$event.stopPropagation()" style="background: white; border-radius: 12px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
      <div class="modal-header" style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #111827;">üì¶ Inventory Details</h3>
        <button class="close-btn" (click)="closeDetails()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280; line-height: 1;">√ó</button>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <div *ngIf="selectedRow()" class="order-details">
          <div class="form-section" style="margin-bottom: 1.5rem;">
            <h4 class="section-title" style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>üìù</span>
              <span>Summary Information</span>
            </h4>
            <div class="order-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <div class="info-row" style="display: flex; flex-direction: column; gap: 0.25rem;">
                <span class="info-label" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">SKU:</span>
                <span class="info-value" style="font-size: 1rem; color: #111827; font-weight: 600;">{{ selectedRow()!.sku }}</span>
              </div>
              <div class="info-row" style="display: flex; flex-direction: column; gap: 0.25rem;">
                <span class="info-label" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">Product Code:</span>
                <span class="info-value" style="font-size: 1rem; color: #111827;">{{ selectedRow()!.productCode }}</span>
              </div>
              <div class="info-row" style="display: flex; flex-direction: column; gap: 0.25rem;">
                <span class="info-label" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">Total Quantity:</span>
                <span class="info-value" style="font-size: 1rem; color: #111827;">{{ selectedRow()!.quantity }}</span>
              </div>
              <div class="info-row" style="display: flex; flex-direction: column; gap: 0.25rem;">
                <span class="info-label" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">Total Stock:</span>
                <span class="info-value" style="font-size: 1rem; color: #111827;">{{ selectedRow()!.runningBalanceTotalStock }}</span>
              </div>
              <div class="info-row" style="display: flex; flex-direction: column; gap: 0.25rem;">
                <span class="info-label" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">Total Gross:</span>
                <span class="info-value" style="font-size: 1rem; color: #10b981; font-weight: 600;">‚Ç±{{ selectedRow()!.totalGross | number:'1.2-2' }}</span>
              </div>
              <div class="info-row" style="display: flex; flex-direction: column; gap: 0.25rem;">
                <span class="info-label" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">Total Profit:</span>
                <span class="info-value" style="font-size: 1rem; color: #10b981; font-weight: 600;">‚Ç±{{ selectedRow()!.totalProfit | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <h4 class="section-title" style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>üìã</span>
              <span>Individual Transactions ({{ selectedRow()!.transactions.length }})</span>
            </h4>
            <div class="order-items-table-wrapper" style="overflow-x: auto;">
              <table class="order-items-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #374151;">Invoice No.</th>
                    <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #374151;">Date</th>
                    <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #374151;">Performed By</th>
                    <th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151;">Cost Price</th>
                    <th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151;">Selling Price</th>
                    <th style="padding: 0.75rem; text-align: center; font-size: 0.875rem; font-weight: 600; color: #374151;">Qty</th>
                    <th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151;">Stock</th>
                    <th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151;">Gross</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let txn of selectedRow()!.transactions" style="border-bottom: 1px solid #f3f4f6;">
                    <td style="padding: 0.75rem; font-size: 0.875rem; color: #1f2937;">{{ txn.orderId || 'N/A' }}</td>
                    <td style="padding: 0.75rem; font-size: 0.875rem; color: #1f2937;">{{ txn.date | date:'M/d/yy h:mm a' }}</td>
                    <td style="padding: 0.75rem; font-size: 0.875rem; color: #1f2937;">{{ txn.performedBy || '-' }}</td>
                    <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem; color: #1f2937;">‚Ç±{{ txn.costPrice | number:'1.2-2' }}</td>
                    <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem; color: #1f2937;">‚Ç±{{ txn.sellingPrice | number:'1.2-2' }}</td>
                    <td style="padding: 0.75rem; text-align: center; font-size: 0.875rem; color: #1f2937;">{{ txn.quantity }}</td>
                    <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem; color: #1f2937;">{{ txn.runningBalanceTotalStock || 0 }}</td>
                    <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem; color: #10b981; font-weight: 500;">‚Ç±{{ (txn.sellingPrice * txn.quantity) | number:'1.2-2' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end;">
        <button class="btn btn-secondary" (click)="closeDetails()" style="padding: 0.5rem 1rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Close</button>
      </div>
    </div>
  </div>
</div>
