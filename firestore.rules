rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Authentication requirement for all collections
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the document (UID-based security)
    function isOwner(resource) {
      return resource.data.uid == request.auth.uid;
    }
    
    // Check if creating document with user's UID
    function isCreatingOwnDocument() {
      return request.resource.data.uid == request.auth.uid;
    }

    // ===== MAIN COLLECTIONS WITH UID SECURITY =====
    
    // Products Collection - Read allowed for authenticated users, write requires UID
    match /products/{productId} {
      allow read: if isAuthenticated();  // Allow reading for any authenticated user
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    resource.data.uid == request.auth.uid && 
                    request.resource.data.uid == request.auth.uid;
      allow delete: if isAuthenticated() && isOwner(resource);
    }

    // Product Inventory Collection - Read allowed for authenticated users, write requires UID
    match /productInventory/{batchDocId} {
      allow read: if isAuthenticated();  // Allow reading for any authenticated user
      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.productId is string;
      allow update: if isAuthenticated() &&
        resource.data.uid == request.auth.uid &&
        request.resource.data.uid == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.uid == request.auth.uid;
    }

    // Product Inventory Entries Collection - New enhanced inventory tracking
    match /productInventoryEntries/{entryId} {
      allow read: if isAuthenticated();  // Allow reading for any authenticated user
      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.productId is string &&
        request.resource.data.companyId is string;
      allow update: if isAuthenticated() &&
        resource.data.uid == request.auth.uid &&
        request.resource.data.uid == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.uid == request.auth.uid;
    }
    
    // Orders Collection - Users can only access their own orders
    // Allow migration: if uid doesn't exist, allow authenticated users to read
    match /orders/{orderId} {
      allow read: if isAuthenticated() && 
                  (resource == null || resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // Order Details Collection - Users can only access their own order details
    // Allow migration: if uid doesn't exist, allow authenticated users to read
    match /orderDetails/{orderDetailId} {
      allow read: if isAuthenticated() && 
                  (resource == null || resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // Customers Collection - Users can only access their own customers
    // Allow migration: if uid doesn't exist, allow authenticated users to read
    match /customers/{customerId} {
      allow read: if isAuthenticated() && 
                  (resource == null || resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // Stores Collection - Users can only access their own stores
    // Allow migration: if uid doesn't exist, allow authenticated users to add it
    match /stores/{storeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                    (isCreatingOwnDocument() || 
                     !('uid' in request.resource.data));
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || 
                     (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid) ||
                     !('uid' in request.resource.data));
      allow delete: if isAuthenticated() && 
                    (isOwner(resource) || !('uid' in resource.data));
    }
    
    // Devices Collection - Authenticated users can access devices
    // TODO: Add proper security based on companyId/storeId in the future
    match /devices/{deviceId} {
      allow read, create, update, delete: if isAuthenticated();
    }
    
    // Companies Collection - Users can only access their own companies
    // Allow migration: if uid doesn't exist, allow authenticated users to read
    match /companies/{companyId} {
      allow read: if isAuthenticated() && 
                  (resource == null || resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // Branches Collection - Users can only access their own branches
    // Allow migration: if uid doesn't exist, allow authenticated users to read
    match /branches/{branchId} {
      allow read: if isAuthenticated() && 
                  (resource == null || resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // Categories Collection - Users can only access their own categories
    // Allow migration: if uid doesn't exist, allow authenticated users to read
    match /categories/{categoryId} {
      allow read: if isAuthenticated() && 
                  (resource == null || resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // User Roles Collection - Users can only access their own user roles
    // Allow migration: if uid doesn't exist, allow authenticated users to add it
    match /userRoles/{userRoleId} {
      allow read: if isAuthenticated() && 
                  (resource == null || !exists(/databases/$(database)/documents/userRoles/$(userRoleId)) || 
                   resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || 
                     (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // Role Definitions Collection - Users can only access their own role definitions
    // Allow migration: if uid doesn't exist, allow authenticated users to add it
    match /roledefinition/{roleDefId} {
      allow read: if isAuthenticated() && 
                  (resource == null || !exists(/databases/$(database)/documents/roledefinition/$(roleDefId)) || 
                   resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || 
                     (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // Notifications Collection - Users can only access their own notifications
    // Allow migration: if uid doesn't exist, allow authenticated users to read
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                  (resource == null || resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && isCreatingOwnDocument();
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid));
      allow delete: if isAuthenticated() && isOwner(resource);
    }
    
    // ===== NESTED COLLECTIONS =====
    
    // Company > Store > Branch > Transactions
    match /companies/{companyId}/stores/{storeId}/branches/{branchId}/transactions/{transactionId} {
      allow read, write: if isAuthenticated() && 
                        (resource == null || isOwner(resource)) &&
                        (request.resource == null || isCreatingOwnDocument());
    }
    
    // ===== BILLING HISTORY COLLECTION =====
    
    // Company Billing History - Users can read their company's billing history
    match /companyBillingHistory/{historyId} {
      allow read: if isAuthenticated() &&
                  resource.data.companyId is string;
      allow write: if isAuthenticated() &&
                   request.resource.data.companyId is string;
    }

    // ===== PERMISSIONS COLLECTION =====
    
    // User Permissions - Users can access their own permissions
    match /permissions/{userId} {
      allow read, write: if isAuthenticated() && userId == request.auth.uid;
    }
    
    // ===== USER PROFILE COLLECTION =====
    
    // Users Collection - Users can only access their own profile
    match /users/{userId} {
      allow read, write: if isAuthenticated() && 
                        (userId == request.auth.uid || 
                         (resource != null && isOwner(resource)));
    }
    
    // ===== SYSTEM/SHARED COLLECTIONS =====
    
    // Predefined Types - Read-only for authenticated users
    match /predefinedTypes/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // System managed only
    }
    
    // System configurations - Read-only for authenticated users
    match /systemConfig/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // System managed only
    }

    // Invoices Collection - Users can access their own invoices
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && 
                  (resource == null || resource.data.uid == request.auth.uid || !('uid' in resource.data));
      allow create: if isAuthenticated() && 
                    (isCreatingOwnDocument() || !('uid' in request.resource.data));
      allow update: if isAuthenticated() && 
                    (isOwner(resource) || (!('uid' in resource.data) && request.resource.data.uid == request.auth.uid) ||
                     !('uid' in request.resource.data));
      allow delete: if isAuthenticated() && 
                    (isOwner(resource) || !('uid' in resource.data));
    }

    // Invoice Numbers Collection - For tracking invoice sequences
    match /invoiceNumbers/{docId} {
      allow read, write: if isAuthenticated();
    }

    // Counters Collection - For managing sequential numbers
    match /counters/{counterId} {
      allow read, write: if isAuthenticated();
    }
    
    // ===== CATCH-ALL SECURITY =====
    
    // Any other collection requires authentication only (temporary permissive rule)
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}

// Storage Rules (for file uploads if needed)
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}